<script>
    import { afterUpdate, beforeUpdate } from "svelte";

    export let empty = true;
    export let type = 'default';
    export let name = 'inventory';
    export let invId;
    export let slot;
    export let invert = false;
    export let disabled = false;
    export let data;

    import { closeContext, dragging } from "../../store/stores"
    
    var clicked = false;
    var isDragging = false;
    var itemImage;

    const handleMouseDown = (e) => {
        if (e.button !== 0) return;
        if (empty) return;
        
        clicked = true;
    }
    const handleMouseUp = () => {
        if (!clicked)
        return
    
        disabled = false;
        clicked = false;
        isDragging = false;
        dragging.set(null);
    }
    const handleMouseMove = () => {
        if (clicked && !isDragging)
        {
            disabled = true;
            isDragging = true;
            
            $closeContext()
            console.log(data)
            dragging.set({ isDragging, slot, name, item: data, extra:type, count: data.count, id:invId })
        }
    }
</script>

<svelte:window on:mousemove={handleMouseMove} on:mouseup={handleMouseUp} />

<div on:mousedown={handleMouseDown} on:keydown={() => {}} data-inventory-id={invId} data-empty={empty} data-extra={type} data-slot={slot} data-name={name} class="slot {!empty ? 'active ': ''} {type == 'equipment' ? 'special ' : ''} {type == 'pockets' ? 'special ' : ''} {disabled == true ? 'disabled ': ''}">
    {#if type == 'equipment' || type == 'pockets'}
        <div class="content">
            {#if empty}
                {#if name == 'weapon'}
                    <svg width="44" height="30" viewBox="0 0 44 30" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g opacity="0.35" clip-path="url(#clip0_15687_3509)">
                        <path d="M3.39068 25.4615C4.88889 22.6154 7.96416 16.2308 9.14696 11.6923C9.38352 10.7692 10.2509 10.0769 11.276 10.0769H14.5878C15.6918 10.0769 16.4014 11.2308 15.9283 12.1538C15.2975 13.3846 14.509 15.2308 13.4839 18C11.9068 22.2308 10.8817 24.7692 10.4086 26C10.172 26.6154 9.62007 27 8.98925 27H4.33692C3.54839 27 2.99642 26.1538 3.39068 25.4615Z" fill="white"/>
                        <path d="M43.6057 2.07692H43.448C43.448 1.53846 42.9749 1.15385 42.4229 1.15385H41.7921L40.8459 0.0769231H39.8997L39.6631 1.15385H7.25449L6.93907 0H4.81004L4.65233 1.23077H4.41578C3.8638 1.23077 3.39069 1.69231 3.39069 2.23077V5.38462H5.28316V2.07692H6.2294V5.38462H7.09678V2.07692H8.04302V5.38462H8.9104V2.07692H9.85664V5.38462H10.724V2.07692H11.6703V5.38462H12.6165V2.07692H13.5627V5.38462H43.5269V4.76923H43.6846C43.8423 4.76923 44 4.61539 44 4.46154V2.46154C44 2.23077 43.8423 2.07692 43.6057 2.07692Z" fill="white"/>
                        <path opacity="0.5" d="M43.448 5.69234V5.38464H3.46954L3.39069 5.76926C3.39069 5.76926 2.75986 6.15387 2.75986 6.76926C2.75986 7.38464 3.07527 7.84618 3.62725 7.92311C4.17922 8.00003 5.12545 7.76926 6.2294 9.15387C7.33334 10.5385 6.86022 12.7693 4.49463 17.4616C2.12904 22.1539 0.867389 23.6154 0.157712 26.2308C-0.473113 28.8462 0.551977 30 2.44445 30C4.33692 30 6.86022 30 10.2509 30C10.4875 30 10.8029 30 10.9606 29.9231C11.5914 29.9231 12.3011 29.7693 12.9319 29.3846C13.7204 28.9231 13.8781 28 13.7204 27.6154C13.5627 27.2308 13.5627 26.5385 13.7993 25.8462C13.8781 25.6154 13.957 25.3846 14.0358 25.1539C14.1936 24.8462 14.4301 24.3846 14.8244 24.2308C15.4552 23.9231 15.6129 23.8462 15.4552 23.5385C15.2975 23.2308 14.9821 22.6923 15.2186 22C15.2975 21.7693 15.3763 21.6154 15.4552 21.3846C15.4552 21.3077 15.8495 20.4616 16.3226 20.2308C16.9534 19.9231 17.1111 19.8462 16.9534 19.5385C16.7957 19.1539 16.638 18.6154 16.8746 17.8462C16.9534 17.6923 17.0323 17.5385 17.0323 17.4616C17.19 17.1539 17.2688 16.9231 17.4265 16.6154C17.4265 16.6154 17.8996 15.5385 18.6882 15.4616C19.4767 15.3846 19.7133 15.9231 21.8423 16.077C23.1039 16.1539 28.3871 16.1539 29.5699 16.1539C30.7527 16.1539 30.8315 15.8462 30.5161 15.3846C30.2007 14.9231 30.043 14.4616 30.043 13.9231C30.043 13.3846 30.043 13.6154 30.043 12.1539C30.043 10.6923 31.0681 9.53849 32.8029 9.53849C32.9606 9.53849 33.0394 9.53849 33.1971 9.53849V7.46157C33.1971 7.07695 33.3548 6.76926 33.5914 6.53849L33.6703 6.46157L33.7491 6.53849C33.9857 6.76926 34.1434 7.15387 34.1434 7.46157V9.2308C36.1936 9.15387 35.7204 9.15387 37.5341 9.07695V8.30772H38.9534V9.07695C40.3728 9.07695 41.6344 9.00003 42.3441 9.00003C42.8961 9.00003 43.2903 8.61541 43.2903 8.07695V7.84618H43.448C43.6057 7.84618 43.7634 7.69234 43.7634 7.53849V6.00003C43.7634 5.84618 43.6057 5.69234 43.448 5.69234ZM26.5735 15C24.4445 15.1539 23.1039 15.1539 21.9212 15.077C20.7384 15 19.4767 14.7693 19.3979 12.6154C19.3979 12.3077 19.3979 12.077 19.4767 11.7693C19.9498 12.1539 20.8961 12.3846 20.8961 12.3846C21.3692 13.4616 22.2366 14.1539 22.552 14.3846C22.6308 14.4616 22.7097 14.4616 22.7885 14.3846L23.0251 14.2308C23.1039 14.1539 23.1039 14.077 23.0251 14C22.8674 13.8462 22.7097 13.4616 22.552 12.7693C22.3154 11.8462 22.6308 10.3846 22.7097 9.9231C22.7885 9.9231 22.7885 9.9231 22.8674 9.9231C25.233 9.69234 26.9677 9.30772 27.914 10C28.6237 10.5385 28.8602 11.077 28.8602 12.3846C28.8602 13.6923 28.7025 14.9231 26.5735 15Z" fill="white"/>
                        </g>
                        <defs>
                        <clipPath id="clip0_15687_3509">
                        <rect width="44" height="30" fill="white"/>
                        </clipPath>
                        </defs>
                    </svg>                    
                {:else if name == 'ammo'}
                    <svg width="30" height="36" viewBox="0 0 30 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g opacity="0.35" clip-path="url(#clip0_15687_2588)">
                        <path opacity="0.5" d="M4.45012 0.318612C4.21994 -0.159264 3.60613 -0.159264 3.37595 0.318612C2.68541 1.83189 1.53452 4.77879 1.53452 8.68144V11.8673H6.29155V8.68144C6.29155 4.77879 5.14065 1.83189 4.45012 0.318612Z" fill="white"/>
                        <path opacity="0.5" d="M6.90537 34.3274V33.6106C6.59846 33.6902 6.29156 33.6902 5.98465 33.7699C5.37084 33.8495 4.68031 33.8495 3.98977 33.8495C3.29923 33.8495 2.6087 33.8495 1.99488 33.7699C1.68798 33.7699 1.30435 33.6902 1.07417 33.6106V34.3274C0.690537 34.4867 0.460358 34.5663 0.460358 34.7256V35.2035C0.460358 35.6017 1.99488 35.9203 3.98977 35.9203C5.90793 35.9203 7.51918 35.6017 7.51918 35.2035V34.7256C7.51918 34.646 7.289 34.4867 6.90537 34.3274Z" fill="white"/>
                        <path d="M7.90281 33.3717L7.44245 16.8053L6.59847 14.8141V12.1858C6.59847 11.9469 6.44501 11.7876 6.21483 11.7876H1.61125C1.38107 11.7876 1.22762 11.9469 1.22762 12.1858V14.8141L0.383632 16.8053L0 33.3717C0 33.3717 0.306905 33.9292 3.91304 33.9292C7.59591 33.9292 7.90281 33.3717 7.90281 33.3717Z" fill="white"/>
                        <path opacity="0.5" d="M15.4987 0.318612C15.2685 -0.159264 14.6547 -0.159264 14.4245 0.318612C13.734 1.75224 12.5831 4.77879 12.5831 8.68144V11.8673H17.3401V8.68144C17.3401 4.77879 16.1892 1.83189 15.4987 0.318612Z" fill="white"/>
                        <path opacity="0.5" d="M17.954 34.3274V33.6106C17.647 33.6902 17.3401 33.6902 17.0332 33.7699C16.4194 33.8495 15.7289 33.8495 15.0384 33.8495C14.3478 33.8495 13.6573 33.8495 13.0435 33.7699C12.7366 33.7699 12.3529 33.6902 12.1228 33.6106V34.3274C11.7391 34.4867 11.5089 34.5663 11.5089 34.7256V35.2035C11.5089 35.6017 13.0435 35.9203 15.0384 35.9203C16.9565 35.9203 18.5678 35.6017 18.5678 35.2035V34.7256C18.491 34.646 18.3376 34.4867 17.954 34.3274Z" fill="white"/>
                        <path d="M18.9514 33.3717L18.491 16.8849L17.647 14.8141V12.1858C17.647 11.9469 17.4936 11.7876 17.2634 11.7876H12.6598C12.4297 11.7876 12.2762 11.9469 12.2762 12.1858V14.8141L11.5089 16.8053L11.0486 33.292C11.0486 33.292 11.3555 33.8495 14.9616 33.8495C18.6445 33.9292 18.9514 33.3717 18.9514 33.3717Z" fill="white"/>
                        <path opacity="0.5" d="M26.5473 0.318612C26.3171 -0.159264 25.7033 -0.159264 25.4731 0.318612C24.7826 1.75224 23.6317 4.77879 23.6317 8.68144V11.8673H28.3887V8.68144C28.3887 4.77879 27.2379 1.83189 26.5473 0.318612Z" fill="white"/>
                        <path opacity="0.5" d="M29.0025 34.3274V33.6106C28.6956 33.6902 28.3887 33.6902 28.0818 33.7699C27.468 33.8495 26.7775 33.8495 26.0869 33.8495C25.3964 33.8495 24.7059 33.8495 24.0921 33.7699C23.7851 33.7699 23.4015 33.6902 23.1713 33.6106V34.3274C22.7877 34.4867 22.5575 34.5663 22.5575 34.7256V35.2035C22.5575 35.6017 24.0921 35.9203 26.0869 35.9203C28.0051 35.9203 29.6163 35.6017 29.6163 35.2035V34.7256C29.5396 34.646 29.3094 34.4867 29.0025 34.3274Z" fill="white"/>
                        <path d="M30 33.3717L29.5396 16.885L28.6956 14.8939V12.2655C28.6956 12.0266 28.5422 11.8673 28.312 11.8673H23.7084C23.4782 11.8673 23.3248 12.0266 23.3248 12.2655V14.8939L22.4808 16.885L22.0204 33.3717C22.0204 33.3717 22.3274 33.9293 25.9335 33.9293C29.6931 33.9293 30 33.3717 30 33.3717Z" fill="white"/>
                        </g>
                        <defs>
                        <clipPath id="clip0_15687_2588">
                        <rect width="30" height="36" fill="white"/>
                        </clipPath>
                        </defs>
                    </svg>                    
                {:else if name == 'backpack'}
                    <svg width="30" height="40" viewBox="0 0 30 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g opacity="0.35" clip-path="url(#clip0_15687_3952)">
                        <path opacity="0.5" d="M28.3249 40H1.59898C0.685279 40 0 39.2578 0 38.4415V17.9591C0 9.87009 6.70051 3.33948 15 3.33948C23.2995 3.33948 30 9.87009 30 17.9591V38.4415C30 39.2578 29.2386 40 28.3249 40Z" fill="white"/>
                        <path d="M14.3147 5.56582H15.6853C22.0812 5.56582 27.5634 9.49903 29.6954 14.9907C28.3249 8.31165 22.2335 3.33948 15 3.33948C7.76649 3.33948 1.67512 8.38586 0.304565 14.9907C2.43654 9.49903 7.91878 5.56582 14.3147 5.56582Z" fill="white"/>
                        <path d="M26.3452 24.3413V20.5565C26.3452 19.2949 25.3553 18.3302 24.0609 18.3302H6.24364C4.94923 18.3302 3.95938 19.2949 3.95938 20.5565V24.3413H26.3452Z" fill="white"/>
                        <path d="M8.45177 26.3451L8.83248 29.3136C8.90862 29.6104 8.60405 29.9072 8.1472 29.9072H7.15735C6.77664 29.9072 6.47207 29.6104 6.47207 29.3136L6.85278 26.3451H3.95938V34.2857C3.95938 35.5473 4.94923 36.5121 6.24364 36.5121H24.137C25.4315 36.5121 26.4213 35.5473 26.4213 34.2857V26.3451H8.45177Z" fill="white"/>
                        <g opacity="0.5">
                        <path d="M8.1472 6.38219L3.73096 8.46011V2.22635C3.73096 1.70687 4.18781 1.2616 4.7208 1.2616H7.15735C7.69035 1.2616 8.1472 1.70687 8.1472 2.22635V6.38219Z" fill="white"/>
                        <path d="M21.7766 6.38219L26.1929 8.46011V2.22635C26.1929 1.70687 25.736 1.2616 25.203 1.2616H22.8426C22.3096 1.2616 21.8528 1.70687 21.8528 2.22635V6.38219H21.7766Z" fill="white"/>
                        </g>
                        <path d="M18.198 4.00742H16.8274C16.8274 2.67161 15.9899 0.593692 14.8477 0.593692C13.7056 0.593692 12.868 2.67161 12.868 4.00742H11.4975C11.4975 2.30056 12.9442 0 14.9239 0C16.7513 0 18.198 2.30056 18.198 4.00742Z" fill="white"/>
                        </g>
                        <defs>
                        <clipPath id="clip0_15687_3952">
                        <rect width="30" height="40" fill="white"/>
                        </clipPath>
                        </defs>
                    </svg>                    
                {:else if name == 'phone'}
                    <svg width="26" height="45" viewBox="0 0 26 45" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g opacity="0.35" clip-path="url(#clip0_15687_2339)">
                        <path opacity="0.5" d="M23.7007 4.96204H2.38776V38.0704H23.7007V4.96204Z" fill="white"/>
                        <path d="M21.1361 0H4.95238C2.21088 0 0 2.13878 0 4.79087V40.2091C0 42.8612 2.21088 45 4.95238 45H21.1361C23.8776 45 26.0884 42.8612 26.0884 40.2091V4.79087C26 2.13878 23.8776 0 21.1361 0ZM9.9932 2.05323H16.0952C16.2721 2.05323 16.449 2.22433 16.449 2.48099C16.449 2.73764 16.2721 2.90875 16.0952 2.90875H9.9932C9.81633 2.90875 9.63945 2.73764 9.63945 2.48099C9.63945 2.30989 9.81633 2.05323 9.9932 2.05323ZM13 43.289C11.8503 43.289 10.966 42.4335 10.966 41.3213C10.966 40.2091 11.8503 39.3536 13 39.3536C14.1497 39.3536 15.034 40.2091 15.034 41.3213C15.034 42.4335 14.1497 43.289 13 43.289ZM23.7007 38.0703H2.38775V4.96198H23.7007V38.0703Z" fill="white"/>
                        </g>
                        <defs>
                        <clipPath id="clip0_15687_2339">
                        <rect width="26" height="45" fill="white"/>
                        </clipPath>
                        </defs>
                    </svg>                    
                {/if}
            {:else}
                <div class="item--image" style="background-image: url(./assets/items/{data.name}.png);"></div>
            {/if}
        </div>
    {/if}
    {#if type == 'pockets'}
        <div style="background-image: url(./assets/pockets/pocket_{slot}{invert ? "_i":""}.png);" class="slot--indicator {invert ? 'invert ': ''}">
        </div>
    {:else if empty == false}
        <div class="item--image" style="background-image: url(./assets/items/{data.name}.png);"></div>
    {/if}

    {#if data?.count}
        <div class="item--amount">
            {data?.count || 0}
        </div>
    {/if}
</div>

<style>
    .item--amount {
        height: 26px;
        padding-inline: 10px;
        background: #FFFFFF;
        box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.45);
        border-radius: 10px;

        font-family: 'Outfit';
        font-style: normal;
        font-weight: 700;
        font-size: 14px;
        letter-spacing: 0.02em;

        /* width:fit-content; */
        line-height: 26px;

        color: #000000;
        position: absolute;
        /* left: 50%; */
        /* transform: translateX(-50%); */

        left: 0;
        /* right: 0; */
        text-align: center;
        border-bottom-right-radius: 0;
        border-top-left-radius: 0;

        bottom: 0%;
        z-index: 0;
        
    }
    .item--image {
        width: 54px;
        height: 54px;
        background-repeat: no-repeat;
        background-size: 100%;
        background-position: center;

        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        pointer-events: none;
    }
    .slot.disabled {
        opacity: 0.25;
        pointer-events: none;
    }
    .slot.special {
        padding: 10px;
    }
    .slot.special .content {
        position: relative;
        height: 100%;
        width: 100%;

        background: radial-gradient(89.53% 69.19% at 35.47% 23.84%, rgba(255, 255, 255, 0.02) 0%, rgba(255, 255, 255, 0) 54.08%, rgba(255, 255, 255, 0) 100%) /* warning: gradient uses a rotation that is not supported by CSS and may not behave as expected */, rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 18px;

    }
    .slot.special .content svg {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
    }

    .slot {
        width: 94px;
        height: 94px;

        flex-shrink: 0;
        scroll-snap-align: center;

        background: radial-gradient(89.53% 69.19% at 35.47% 23.84%, rgba(255, 255, 255, 0.02) 0%, rgba(255, 255, 255, 0) 54.08%, rgba(255, 255, 255, 0) 100%) /* warning: gradient uses a rotation that is not supported by CSS and may not behave as expected */, rgba(255, 255, 255, 0.01);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 24px;
        position: relative;
    }
    .slot.active {
        background: radial-gradient(89.53% 69.19% at 35.47% 23.84%, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0) 54.08%, rgba(255, 255, 255, 0) 100%) /* warning: gradient uses a rotation that is not supported by CSS and may not behave as expected */, rgba(255, 255, 255, 0.09);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 24px;
    }
    .slot--indicator.invert {
        left: -60%;
        right: unset;
    }
    .slot--indicator {
        position: absolute;
        right: -60%;
        top: 50%;
        transform: translateY(-50%);

        width: 82px;
        height: 162px;

        background-size: 60%;
        background-repeat: no-repeat;
        background-position: center;

        opacity: 0.4;
    }
</style>